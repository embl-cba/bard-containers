ARG TAG=3.0
FROM abcdesktopio/oc.template.ubuntu.20.04:$TAG

ENV DEBIAN_FRONTEND noninteractive
ENV TZ Europe/Berlin
ENV NVIDIA_VISIBLE_DEVICES "all",
ENV NVIDIA_DRIVER_CAPABILITIES "all"
ENV PATH=/usr/local/cuda-11.4/bin${PATH:+:${PATH}}
ENV LD_LIBRARY_PATH=usr/local/cuda-11.4/lib64$LD_LIBRARY_PATH:$CONDA_PREFIX/lib/

RUN apt-get update -y && \
    apt-get install -y libasound2 apt-utils apt-transport-https software-properties-common wget gnupg2 && \
    apt-key adv --keyserver keyserver.ubuntu.com --recv-keys E298A3A825C0D65DFD57CBB651716619E084DAB9 &&\
    add-apt-repository 'deb https://cloud.r-project.org/bin/linux/ubuntu focal-cran40/' && \
    apt-get update -y 


WORKDIR /tmp
RUN apt-get install -y nvidia-cuda-toolkit gnome-terminal konsole r-base r-base-core r-recommended r-base-dev && \
    apt-get install -y libnss3 qt5-default libcurl4-openssl-dev \
    libxml2-dev libmagick++-dev git libgdal-dev libgeos-dev \
    libprotobuf-dev libprotoc-dev libudunits2-dev libjq-dev \
    libssl-dev \
    openjdk-11-jdk libv8-dev libgsl-dev > /dev/null 2>&1

RUN wget https://s3.amazonaws.com/rstudio-ide-build/desktop/bionic/amd64/rstudio-2022.02.3-492-amd64.deb && \
    apt-get update -y

RUN apt-get install -y libssl-dev qml-module-qtquick-controls libqt5webkit5-dev --no-install-recommends && \
    apt-get install -y libfftw3-dev libgmp3-dev libgit2-dev libssh-dev &&\
    apt-get install -y /tmp/rstudio-*.deb && \
    apt-get install -y default-jre default-jdk python3-venv python3-pip

RUN pip install nvidia-cudnn-cu11==8.6.0.163

RUN R CMD javareconf && \
    R -e "install.packages(c('rJava','devtools'))"

LABEL oc.icon="rstudio.svg"
LABEL oc.icondata="PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz4KPCEtLSBHZW5lcmF0b3I6IEFkb2JlIElsbHVzdHJhdG9yIDIyLjEuMCwgU1ZHIEV4cG9ydCBQbHVnLUluIC4gU1ZHIFZlcnNpb246IDYuMDAgQnVpbGQgMCkgIC0tPgo8c3ZnIHZlcnNpb249IjEuMSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayIgeD0iMHB4IiB5PSIwcHgiCgkgdmlld0JveD0iMCAwIDE3ODQuMSA2MjUuOSIgc3R5bGU9ImVuYWJsZS1iYWNrZ3JvdW5kOm5ldyAwIDAgMTc4NC4xIDYyNS45OyIgeG1sOnNwYWNlPSJwcmVzZXJ2ZSI+CjxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+Cgkuc3Qwe2ZpbGw6Izc1QUFEQjt9Cgkuc3Qxe2ZpbGw6IzRENEQ0RDt9Cgkuc3Qye2ZpbGw6I0ZGRkZGRjt9Cgkuc3Qze2ZpbGw6dXJsKCNTVkdJRF8xXyk7fQoJLnN0NHtmaWxsOnVybCgjU1ZHSURfMl8pO30KCS5zdDV7ZmlsbDp1cmwoI1NWR0lEXzNfKTt9Cgkuc3Q2e2ZpbGw6dXJsKCNTVkdJRF80Xyk7fQoJLnN0N3tmaWxsOnVybCgjU1ZHSURfNV8pO30KCS5zdDh7ZmlsbDp1cmwoI1NWR0lEXzZfKTt9Cgkuc3Q5e2ZpbGw6dXJsKCNTVkdJRF83Xyk7fQoJLnN0MTB7ZmlsbDp1cmwoI1NWR0lEXzhfKTt9Cgkuc3QxMXtmaWxsOnVybCgjU1ZHSURfOV8pO30KCS5zdDEye2ZpbGw6dXJsKCNTVkdJRF8xMF8pO30KCS5zdDEze29wYWNpdHk6MC4xODtmaWxsOnVybCgjU1ZHSURfMTFfKTt9Cgkuc3QxNHtvcGFjaXR5OjAuMzt9Cjwvc3R5bGU+CjxnIGlkPSJHcmF5X0xvZ28iPgo8L2c+CjxnIGlkPSJCbGFja19MZXR0ZXJzIj4KPC9nPgo8ZyBpZD0iQmx1ZV9HcmFkaWVudF9MZXR0ZXJzIj4KCTxnPgoJCQoJCQk8ZWxsaXBzZSB0cmFuc2Zvcm09Im1hdHJpeCgwLjcwNzEgLTAuNzA3MSAwLjcwNzEgMC43MDcxIC0xMjcuOTI2NSAzMTcuMDMxNykiIGNsYXNzPSJzdDAiIGN4PSIzMTguNyIgY3k9IjMxMi45IiByeD0iMzA5LjgiIHJ5PSIzMDkuOCIvPgoJCTxnPgoJCQk8cGF0aCBjbGFzcz0ic3QxIiBkPSJNNjk0LjQsNDA0LjhjMTYuMSwxMC4zLDM5LjEsMTguMSw2My45LDE4LjFjMzYuNywwLDU4LjEtMTkuNCw1OC4xLTQ3LjRjMC0yNS41LTE0LjgtNDAuOC01Mi4zLTU0LjgKCQkJCWMtNDUuMy0xNi41LTczLjMtNDAuNC03My4zLTc5LjFjMC00My4zLDM1LjgtNzUuNCw4OS44LTc1LjRjMjgsMCw0OSw2LjYsNjEsMTMuNmwtOS45LDI5LjNjLTguNy01LjQtMjcuMi0xMy4yLTUyLjMtMTMuMgoJCQkJYy0zNy45LDAtNTIuMywyMi43LTUyLjMsNDEuNmMwLDI2LDE2LjksMzguNyw1NS4yLDUzLjZjNDcsMTguMSw3MC41LDQwLjgsNzAuNSw4MS42YzAsNDIuOC0zMS4zLDgwLjMtOTYuOCw4MC4zCgkJCQljLTI2LjgsMC01Ni04LjItNzAuOS0xOC4xTDY5NC40LDQwNC44eiIvPgoJCQk8cGF0aCBjbGFzcz0ic3QxIiBkPSJNOTQzLjMsMjAxLjN2NDcuOGg1MS45djI3LjZoLTUxLjl2MTA3LjVjMCwyNC43LDcsMzguNywyNy4yLDM4LjdjOS45LDAsMTUuNy0wLjgsMjEtMi41bDEuNiwyNy42CgkJCQljLTcsMi41LTE4LjEsNC45LTMyLjEsNC45Yy0xNi45LDAtMzAuNS01LjgtMzkuMS0xNS4yYy05LjktMTEuMS0xNC0yOC44LTE0LTUyLjNWMjc2LjdoLTMwLjl2LTI3LjZoMzAuOVYyMTJMOTQzLjMsMjAxLjN6Ii8+CgkJCTxwYXRoIGNsYXNzPSJzdDEiIGQ9Ik0xMjAyLjgsMzkzLjdjMCwyMSwwLjQsMzkuMSwxLjYsNTQuOGgtMzIuMWwtMi4xLTMyLjVoLTAuOGMtOS4xLDE2LjEtMzAuNSwzNy4xLTY1LjksMzcuMQoJCQkJYy0zMS4zLDAtNjguOC0xNy43LTY4LjgtODcuM1YyNDkuMWgzNi4zdjExMGMwLDM3LjksMTEuOSw2My45LDQ0LjUsNjMuOWMyNC4zLDAsNDEuMi0xNi45LDQ3LjgtMzMuNGMyLjEtNC45LDMuMy0xMS41LDMuMy0xOC41CgkJCQl2LTEyMmgzNi4zVjM5My43eiIvPgoJCQk8cGF0aCBjbGFzcz0ic3QxIiBkPSJNMTQzNC44LDE1NnYyNDFjMCwxNy43LDAuOCwzNy45LDEuNiw1MS41aC0zMi4xbC0xLjYtMzQuNmgtMS4yYy0xMC43LDIyLjItMzQuNiwzOS4xLTY3LjIsMzkuMQoJCQkJYy00OC4yLDAtODUuNy00MC44LTg1LjctMTAxLjRjLTAuNC02Ni4zLDQxLjItMTA2LjcsODkuNC0xMDYuN2MzMC45LDAsNTEuMSwxNC40LDYwLjIsMzAuMWgwLjhWMTU2SDE0MzQuOHogTTEzOTguOSwzMzAuMgoJCQkJYzAtNC41LTAuNC0xMC43LTEuNi0xNS4yYy01LjQtMjIuNy0yNS4xLTQxLjYtNTIuMy00MS42Yy0zNy41LDAtNTkuNywzMy01OS43LDc2LjZjMCw0MC40LDIwLjIsNzMuOCw1OC45LDczLjgKCQkJCWMyNC4zLDAsNDYuNi0xNi41LDUzLjEtNDMuM2MxLjItNC45LDEuNi05LjksMS42LTE1LjdWMzMwLjJ6Ii8+CgkJCTxwYXRoIGNsYXNzPSJzdDEiIGQ9Ik0xNTM1LjcsMTkzYzAsMTIuNC04LjcsMjIuMi0yMy4xLDIyLjJjLTEzLjIsMC0yMS44LTkuOS0yMS44LTIyLjJjMC0xMi40LDkuMS0yMi43LDIyLjctMjIuNwoJCQkJQzE1MjYuNiwxNzAuNCwxNTM1LjcsMTgwLjMsMTUzNS43LDE5M3ogTTE0OTUuMyw0NDguNVYyNDkuMWgzNi4zdjE5OS40SDE0OTUuM3oiLz4KCQkJPHBhdGggY2xhc3M9InN0MSIgZD0iTTE3NzIuMiwzNDcuMWMwLDczLjctNTEuNSwxMDUuOS05OS4zLDEwNS45Yy01My42LDAtOTUuNi0zOS42LTk1LjYtMTAyLjZjMC02Ni4zLDQ0LjEtMTA1LjUsOTguOS0xMDUuNQoJCQkJQzE3MzMuNSwyNDUsMTc3Mi4yLDI4Ni42LDE3NzIuMiwzNDcuMXogTTE2MTQuNCwzNDkuMmMwLDQzLjcsMjQuNyw3Ni42LDYwLjIsNzYuNmMzNC42LDAsNjAuNi0zMi41LDYwLjYtNzcuNQoJCQkJYzAtMzMuOC0xNi45LTc2LjItNTkuNy03Ni4yQzE2MzIuOSwyNzIuMSwxNjE0LjQsMzExLjcsMTYxNC40LDM0OS4yeiIvPgoJCTwvZz4KCQk8Zz4KCQkJPHBhdGggY2xhc3M9InN0MiIgZD0iTTQyNC43LDQxMS44aDMzLjZ2MjYuMWgtNTEuM0wzMjIsMzEwLjVoLTQ1LjN2MTAxLjNoNDQuM3YyNi4xSDIwOS41di0yNi4xaDM4LjNWMTg3LjNsLTM4LjMtNC43di0yNC43CgkJCQljMTQuNSwzLjMsMjcuMSw1LjYsNDIuOSw1LjZjMjMuOCwwLDQ4LjEtNS42LDcxLjktNS42YzQ2LjIsMCw4OS4xLDIxLDg5LjEsNzIuM2MwLDM5LjctMjMuOCw2NC45LTYwLjcsNzUuNkw0MjQuNyw0MTEuOHoKCQkJCSBNMjc2LjcsMjg1LjNsMjQuMywwLjVjNTkuMywwLjksODIuMS0yMS45LDgyLjEtNTIuM2MwLTM1LjUtMjUuNy00OS41LTU4LjMtNDkuNWMtMTUuNCwwLTMxLjMsMS40LTQ4LjEsMy4zVjI4NS4zeiIvPgoJCTwvZz4KCQk8Zz4KCQkJPHBhdGggY2xhc3M9InN0MSIgZD0iTTE3NTEuOCwxNzAuNGMtMTIuOSwwLTIzLjQsMTAuNS0yMy40LDIzLjRjMCwxMi45LDEwLjUsMjMuNCwyMy40LDIzLjRjMTIuOSwwLDIzLjQtMTAuNSwyMy40LTIzLjQKCQkJCUMxNzc1LjIsMTgwLjksMTc2NC43LDE3MC40LDE3NTEuOCwxNzAuNHogTTE3NzEuNCwxOTMuOGMwLDEwLjgtOC44LDE5LjUtMTkuNSwxOS41Yy0xMC44LDAtMTkuNS04LjgtMTkuNS0xOS41CgkJCQljMC0xMC44LDguOC0xOS41LDE5LjUtMTkuNUMxNzYyLjYsMTc0LjIsMTc3MS40LDE4MywxNzcxLjQsMTkzLjh6Ii8+CgkJCTxwYXRoIGNsYXNzPSJzdDEiIGQ9Ik0xNzYwLjEsMjAzLjNsLTUuOC04LjVjMy4zLTEuMiw1LTMuNiw1LTdjMC01LjEtNC4zLTYuOS04LjQtNi45Yy0xLjEsMC0yLjIsMC4xLTMuMiwwLjMKCQkJCWMtMSwwLjEtMi4xLDAuMi0zLjEsMC4yYy0xLjQsMC0yLjUtMC4yLTMuNy0wLjVsLTAuNi0wLjF2My4zbDMuNCwwLjR2MTguOGgtMy40djMuNGgxMC45di0zLjRoLTMuOXYtNy45aDMuMmw3LjMsMTFsMC4yLDAuMmg1LjMKCQkJCXYtMy40SDE3NjAuMXogTTE3NTUuNiwxODguMWMwLDEuMi0wLjUsMi4yLTEuNCwyLjljLTEuMSwwLjgtMi44LDEuMi01LDEuMmwtMS45LDB2LTcuN2MxLjQtMC4xLDIuNi0wLjIsMy43LTAuMgoJCQkJQzE3NTMuMSwxODQuMywxNzU1LjYsMTg1LDE3NTUuNiwxODguMXoiLz4KCQk8L2c+Cgk8L2c+CjwvZz4KPGcgaWQ9IldoaXRlX0xldHRlcnMiPgo8L2c+CjxnIGlkPSJSX0JhbGwiPgo8L2c+Cjwvc3ZnPgo="
LABEL oc.keyword="RStudio"
LABEL oc.cat="development"
LABEL oc.template="abcdesktopio/oc.template.ubuntu.nvidia.20.04"
LABEL oc.name="RStudio"
LABEL oc.launch="rstudio.RStudio"
LABEL oc.displayname="RStudio"
LABEL oc.path="/usr/bin/rstudio"
LABEL oc.rules="{\"homedir\":{\"default\":true}}"
LABEL oc.type=app
LABEL oc.showinview=dock
LABEL oc.acl="{\"permit\":[\"all\"]}"
LABEL oc.containerengine="pod_application"
LABEL oc.executeclassname="programming"

RUN  if [ -d /usr/share/icons ];   then cd /usr/share/icons;    /composer/safelinks.sh; fi 
RUN  if [ -d /usr/share/pixmaps ]; then cd /usr/share/pixmaps;  /composer/safelinks.sh; fi 

ENV APPNAME "rstudio"
ENV APPBIN "/usr/bin/rstudio"
ENV APP "/usr/bin/rstudio"


RUN mkdir -p /run/user
RUN chmod 777 /run/user
RUN mkdir -p /etc/localaccount
RUN for f in passwd shadow group gshadow ; do if [ -f /etc/$f ] ; then  cp /etc/$f /etc/localaccount; rm -f /etc/$f; ln -s /etc/localaccount/$f /etc/$f; fi; done



CMD /usr/bin/rstudio
