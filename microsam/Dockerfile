FROM registry.git.embl.org/grp-cbbcs/abcdesktop-apps/base-image:ubuntu22-cuda-12-3

ARG DEBIAN_FRONTEND="noninteractive"

ENV LANG en_US.UTF-8 \
    LC_ALL en_US.UTF-8 \
    LANGUAGE en_US:en  \
    NUMBA_CACHE_DIR=/tmp

ENV CONDA_BIN_PATH="/opt/conda/bin"
ENV PATH $CONDA_BIN_PATH:$PATH
ENV NVIDIA_DRIVER_CAPABILITIES "compute,utility"

RUN apt-get update -y && \
    apt-get install -y -q --no-install-recommends \
            gcc \
            wget \
            qtcreator \
            python3-dev \
            python3-pip \
            python3-wheel \
            libblas-dev \
            liblapack-dev \
            libgl1 \
            mesa-utils \
            libxcb-cursor0 \
            libgl1-mesa-glx \
            libxcb-xinerama0 \
            libatlas-base-dev \
            gfortran \
            apt-utils \
            bzip2 \
            ca-certificates \
            curl \
            konsole \
            locales \
            libarchive-dev \
            cmake \
            libxcb-cursor0 \
            libxcb-cursor-dev \
            unzip &&  apt-get clean && \
            rm -rf /var/lib/apt/lists/* && \
            sed -i '/en_US.UTF-8/s/^# //g' /etc/locale.gen && \
            locale-gen

WORKDIR /tmp
RUN wget https://github.com/conda-forge/miniforge/releases/latest/download/Miniforge3-Linux-x86_64.sh \
    && bash Miniforge3-Linux-x86_64.sh -b -p /opt/conda \
    && rm -f Miniforge3-Linux-x86_64.sh 

LABEL oc.icon="microsam.svg"
LABEL oc.icondata="PD94bWwgdmVyc2lvbj0iMS4wIiBzdGFuZGFsb25lPSJubyI/Pgo8IURPQ1RZUEUgc3ZnIFBVQkxJQyAiLS8vVzNDLy9EVEQgU1ZHIDIwMDEwOTA0Ly9FTiIKICJodHRwOi8vd3d3LnczLm9yZy9UUi8yMDAxL1JFQy1TVkctMjAwMTA5MDQvRFREL3N2ZzEwLmR0ZCI+CjxzdmcgdmVyc2lvbj0iMS4wIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciCiB3aWR0aD0iMTI4MS4wMDAwMDBwdCIgaGVpZ2h0PSI0MDEuMDAwMDAwcHQiIHZpZXdCb3g9IjAgMCAxMjgxLjAwMDAwMCA0MDEuMDAwMDAwIgogcHJlc2VydmVBc3BlY3RSYXRpbz0ieE1pZFlNaWQgbWVldCI+Cgo8ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSgwLjAwMDAwMCw0MDEuMDAwMDAwKSBzY2FsZSgwLjEwMDAwMCwtMC4xMDAwMDApIgpmaWxsPSIjMDAwMDAwIiBzdHJva2U9Im5vbmUiPgo8cGF0aCBkPSJNMTAgMzkyNSBsMCAtNzUgMzUgMCBjMzMgMCAzNSAyIDM1IDM1IDAgMzQgMSAzNSA0MCAzNSBsNDAgMCAwIDQwIDAKNDAgLTc1IDAgLTc1IDAgMCAtNzV6Ii8+CjxwYXRoIGQ9Ik0zODAgMzk2MCBsMCAtNDAgMTA1IDAgMTA1IDAgMCA0MCAwIDQwIC0xMDUgMCAtMTA1IDAgMCAtNDB6Ii8+CjxwYXRoIGQ9Ik04MTAgMzk2MCBsMCAtNDEgMTA4IDMgMTA3IDMgMCAzNSAwIDM1IC0xMDcgMyAtMTA4IDMgMCAtNDF6Ii8+CjxwYXRoIGQ9Ik0xMjQwIDM5NjAgbDAgLTQwIDExMCAwIDExMCAwIDAgNDAgMCA0MCAtMTEwIDAgLTExMCAwIDAgLTQweiIvPgo8cGF0aCBkPSJNMTY4MCAzOTYwIGwwIC00MCAxMDUgMCAxMDUgMCAwIDQwIDAgNDAgLTEwNSAwIC0xMDUgMCAwIC00MHoiLz4KPHBhdGggZD0iTTIxMTAgMzk2MCBsMCAtNDAgMTA1IDAgMTA1IDAgMCA0MCAwIDQwIC0xMDUgMCAtMTA1IDAgMCAtNDB6Ii8+CjxwYXRoIGQ9Ik0yNTQwIDM5NjAgbDAgLTMwIDExMCAwIDExMCAwIDAgMzAgMCAzMCAtMTEwIDAgLTExMCAwIDAgLTMweiIvPgo8cGF0aCBkPSJNMjk4MCAzOTYwIGwwIC0zMCAxMDUgMCAxMDUgMCAwIDMwIDAgMzAgLTEwNSAwIC0xMDUgMCAwIC0zMHoiLz4KPHBhdGggZD0iTTM0MTAgMzk2MCBsMCAtMzAgMTA1IDAgMTA1IDAgMCAzMCAwIDMwIC0xMDUgMCAtMTA1IDAgMCAtMzB6Ii8+CjxwYXRoIGQ9Ik0zODQwIDM5NjAgbDAgLTMwIDEwNSAwIDEwNSAwIDAgMzAgMCAzMCAtMTA1IDAgLTEwNSAwIDAgLTMweiIvPgo8cGF0aCBkPSJNNDI4MCAzOTYwIGwwIC0zMCAxMDUgMCAxMDUgMCAwIDMwIDAgMzAgLTEwNSAwIC0xMDUgMCAwIC0zMHoiLz4KPHBhdGggZD0iTTQ3MTAgMzk2MCBsMCAtMzAgMTA1IDAgMTA1IDAgMCAzMCAwIDMwIC0xMDUgMCAtMTA1IDAgMCAtMzB6Ii8+CjxwYXRoIGQ9Ik01MTQwIDM5NjAgbDAgLTMwIDEwNSAwIDEwNSAwIDAgMzAgMCAzMCAtMTA1IDAgLTEwNSAwIDAgLTMweiIvPgo8cGF0aCBkPSJNNTU4MCAzOTYwIGMwIC0yOCAzIC0zMCAzNSAtMzAgMzQgMCAzNSAtMSAzNSAtNDAgMCAtMzkgMSAtNDAgMzUKLTQwIGwzNSAwIDAgNzAgMCA3MCAtNzAgMCAtNzAgMCAwIC0zMHoiLz4KPHBhdGggZD0iTTEwIDM1MjAgbDAgLTExMCAzNSAwIDM1IDAgMCAxMTAgMCAxMTAgLTM1IDAgLTM1IDAgMCAtMTEweiIvPgo8cGF0aCBkPSJNNTY1MCAzNTI1IGwwIC0xMDUgMzUgMCAzNSAwIDAgMTA1IDAgMTA1IC0zNSAwIC0zNSAwIDAgLTEwNXoiLz4KPHBhdGggZD0iTTMxNDEgMzI4OSBjLTk4IC01NiAtMjc2IC0yNTYgLTQyNyAtNDc5IC0xMDQgLTE1MyAtMjAwIC0zMTYgLTM4OQotNjYwIC0zNTkgLTY1MiAtNTEyIC04NzggLTc0NiAtMTEwNSAtMjA0IC0xOTggLTMxNCAtMjQ0IC00MjEgLTE3NiAtNTkgMzcKLTg4IDk2IC04OCAxNzYgMCA1MSA4IDc1IDUzIDE3MCA0NCA5MiA1MiAxMTkgNTIgMTY1IC0xIDkyIC02MSAxNzYgLTE0NSAyMDEKLTgwIDI0IC0xOTggLTM5IC0yOTIgLTE1NSAtMTg5IC0yMzUgLTIyOCAtNTYxIC04OSAtNzQ2IDk0IC0xMjUgMjIyIC0xODAgNDE5Ci0xODAgMjIzIDAgNDU5IDgwIDY5NyAyMzcgMzAzIDIwMCA2NjcgNjAyIDk1NCAxMDU3IDEwMCAxNTggMTI4IDE4NCAxNzEgMTYzCjMzIC0xNyA2OCAtNzEgODQgLTEzMSA1NiAtMjAyIDcxIC0yNTAgMTAxIC0zMTkgNTAgLTExNiA5MiAtMTgyIDE2NSAtMjU3IDg5Ci05MSAxNTkgLTEyNCAyNjAgLTEyNSAxNzAgMCAyNzUgOTkgNTk5IDU3MCAxMjYgMTgyIDE1MiAyMDMgMTg3IDE1MCAxMiAtMTgKMTUgLTM3IDEwIC02OCAtNzYgLTUzMSAtOTggLTcyOCAtOTQgLTg1NyAzIC0xMTkgNyAtMTQxIDI5IC0xOTAgNjMgLTEzNSAxNzMKLTE3NSAyNTIgLTkyIDQ3IDQ5IDU4IDEwMSA2OCAzMDcgMTggNDAzIDY4IDU2OCAzNDggMTEzNCAxMDcgMjE3IDE4OSAzOTUgMjA5CjQ1NiA5OCAzMDQgODAgNDY4IC01NyA1MTQgLTE3NCA1OCAtNTA5IC0xNTAgLTczOCAtNDU5IC0zOSAtNTIgLTE0NyAtMjAzCi0yNDEgLTMzNSAtMjQyIC0zNDIgLTMyMiAtNDMwIC00MzggLTQ4OSAtNTkgLTMwIC0xMzggLTM1IC0xODMgLTEyIC0xMzMgNjkKLTIxNyAzMzQgLTE4MiA1NzcgNyA0NiAzOSAxOTAgNzIgMzE5IDMyIDEyOSA2MyAyNzMgNjggMzIwIDE4IDE2MyAtMTggMjk4Ci04OSAzMzUgLTQ5IDI1IC0xMTggMTkgLTE3OSAtMTZ6IG0xNjc1IC01MjQgYzEyMiAtMzYgMTg4IC0xODMgMTM1IC0zMDEgLTM5Ci04NSAtMTUwIC0xNDYgLTIzOSAtMTI5IC01NSAxMCAtMTE1IDQ4IC0xNDcgOTYgLTQxIDU4IC00NyAxNTcgLTE1IDIyNCAyNCA1MAo3MCA5MCAxMjcgMTExIDUwIDE3IDc5IDE3IDEzOSAtMXoiLz4KPHBhdGggZD0iTTEwIDMwOTAgbDAgLTExMCAzNSAwIDM1IDAgMCAxMTAgMCAxMTAgLTM1IDAgLTM1IDAgMCAtMTEweiIvPgo8cGF0aCBkPSJNNTY1MCAzMDg1IGwwIC0xMDUgMzUgMCAzNSAwIDAgMTA1IDAgMTA1IC0zNSAwIC0zNSAwIDAgLTEwNXoiLz4KPHBhdGggZD0iTTY4MTUgMjk5OSBjLTI2NyAtMzYgLTQ2MCAtMTc0IC01MzcgLTM4NCAtMjYgLTcyIC0zNyAtMjYzIC0xOSAtMzQ1CjE3IC04MSA2MCAtMTYwIDExNiAtMjE3IDkxIC05MCAyMjEgLTE0MiA1MzYgLTIxMiAzMDAgLTY3IDM4NCAtOTggNDQzIC0xNjAKMjMgLTI0IDMwIC00MiAzNCAtODUgNyAtODEgLTUgLTEyMiAtNDUgLTE2NyAtNjYgLTczIC0xNzMgLTEwOSAtMzI4IC0xMDkKLTI0NyAwIC0zODIgODggLTQxMSAyNjggbC03IDQyIC0xOTMgMCAtMTkzIDAgNiAtNTggYzIwIC0yMTkgMTMwIC0zODEgMzI1Ci00NzcgMTQyIC02OSAyMjIgLTg3IDQyMyAtOTIgMzI4IC05IDUzMCA1OSA2NzkgMjI5IDE3MSAxOTYgMTgxIDUzMCAyMCA3MDgKLTkwIDEwMCAtMTk3IDE0NCAtNTUwIDIzMSAtMzMzIDgxIC0zOTUgMTAyIC00NDMgMTQ3IC00NCA0MiAtNjUgMTAwIC01NSAxNTMKMjYgMTM1IDE0MCAyMDMgMzM5IDIwMyAyMDQgMCAzMzIgLTc2IDM2NiAtMjE5IDYgLTI3IDEzIC01NiAxNSAtNjMgMyAtMTAgNDYKLTEyIDE5MSAtMTAgbDE4OCAzIC0zIDUwIGMtMTcgMjY2IC0yMDIgNDY5IC00OTggNTQ2IC05MiAyNCAtMjkyIDMzIC0zOTkgMTh6Ii8+CjxwYXRoIGQ9Ik0xMDg2NiAyOTUzIGMtOCAtOCAtOCAtMTUxOCAxIC0xNzQxIGw2IC0xNzIgMTgxIDIgMTgxIDMgMyA3ODAgMwo3ODAgMTU0IC02ODAgYzg0IC0zNzQgMTY0IC03MjUgMTc3IC03ODAgbDIzIC0xMDAgNDggMCBjMjYgMSAxMTIgMiAxOTIgMwpsMTQ0IDIgMTAgMzggYzE5IDcxIDM0MSAxNTAzIDM0MSAxNTE3IDAgOCAzIDE2IDggMTggNCAzIDYgLTM1MCA0IC03ODQgbC0yCi03ODkgMTg1IDAgMTg1IDAgMCA5NTAgMCA5NTAgLTI4NyAtMiAtMjg3IC0zIC0xNzAgLTczOSBjLTExMiAtNDg1IC0xNzMgLTczMgotMTc4IC03MjAgLTQgMTEgLTgyIDM0MyAtMTczIDczOCAtOTEgMzk2IC0xNjcgNzIxIC0xNjggNzIyIC03IDUgLTU3NSAxMgotNTgxIDd6Ii8+CjxwYXRoIGQ9Ik05MDY5IDI5MjMgYy00NiAtMTE5IC02NjkgLTE4NjUgLTY2OSAtMTg3NCAwIC02IDgzIC04IDIwNyAtNyBsMjA3CjMgNjcgMTk1IDY3IDE5NSAzNTAgMyAzNTAgMiAxMSAtMzIgYzUgLTE4IDMzIC0xMDYgNjEgLTE5NSBsNTEgLTE2MyAyMTYgMApjMTY4IDAgMjE0IDMgMjEwIDEzIC0yIDYgLTEwNCAyOTYgLTIyNyA2NDIgLTIxNCA2MDggLTQyMSAxMTkxIC00MzUgMTIyOCAtNwoxNSAtMjcgMTcgLTIzMSAxNyBsLTIyNCAwIC0xMSAtMjd6IG0zNDkgLTc4MCBjNjIgLTE5NyAxMTMgLTM2MSAxMTIgLTM2NSAwCi05IC00NzAgLTExIC00NzAgLTIgMCAxNSAyMzUgNzI0IDI0MCA3MjQgMyAwIDU2IC0xNjEgMTE4IC0zNTd6Ii8+CjxwYXRoIGQ9Ik0xMCAyNjUwIGwwIC0xMTAgMzUgMCAzNSAwIDAgMTEwIDAgMTEwIC0zNSAwIC0zNSAwIDAgLTExMHoiLz4KPHBhdGggZD0iTTU2NTAgMjY1NSBsMCAtMTA1IDM1IDAgMzUgMCAwIDEwNSAwIDEwNSAtMzUgMCAtMzUgMCAwIC0xMDV6Ii8+CjxwYXRoIGQ9Ik0xMCAyMjIwIGwwIC0xMTAgMzUgMCAzNSAwIDAgMTEwIDAgMTEwIC0zNSAwIC0zNSAwIDAgLTExMHoiLz4KPHBhdGggZD0iTTU2NTAgMjIxNSBsMCAtMTA1IDM1IDAgMzUgMCAwIDEwNSAwIDEwNSAtMzUgMCAtMzUgMCAwIC0xMDV6Ii8+CjxwYXRoIGQ9Ik0xMCAxNzg1IGwwIC0xMDUgMzUgMCAzNSAwIDAgMTA1IDAgMTA1IC0zNSAwIC0zNSAwIDAgLTEwNXoiLz4KPHBhdGggZD0iTTU2NTAgMTc4NSBsMCAtMTA1IDM1IDAgMzUgMCAwIDEwNSAwIDEwNSAtMzUgMCAtMzUgMCAwIC0xMDV6Ii8+CjxwYXRoIGQ9Ik0xMCAxMzUwIGwwIC0xMTAgMzUgMCAzNSAwIDAgMTEwIDAgMTEwIC0zNSAwIC0zNSAwIDAgLTExMHoiLz4KPHBhdGggZD0iTTU2NTAgMTM1MCBsMCAtMTEwIDM1IDAgMzUgMCAwIDExMCAwIDExMCAtMzUgMCAtMzUgMCAwIC0xMTB6Ii8+CjxwYXRoIGQ9Ik0xMCA5MTUgbDAgLTEwNSAzNSAwIDM1IDAgMCAxMDUgMCAxMDUgLTM1IDAgLTM1IDAgMCAtMTA1eiIvPgo8cGF0aCBkPSJNNTY1MCA5MTUgbDAgLTEwNSAzNSAwIDM1IDAgMCAxMDUgMCAxMDUgLTM1IDAgLTM1IDAgMCAtMTA1eiIvPgo8cGF0aCBkPSJNMTAgNDgwIGwwIC0xMTAgMzUgMCAzNSAwIDAgMTEwIDAgMTEwIC0zNSAwIC0zNSAwIDAgLTExMHoiLz4KPHBhdGggZD0iTTU2NTAgNDgwIGwwIC0xMTAgMzUgMCAzNSAwIDAgMTEwIDAgMTEwIC0zNSAwIC0zNSAwIDAgLTExMHoiLz4KPHBhdGggZD0iTTEwIDgwIGwwIC03MCA3NSAwIDc1IDAgMCAzNSBjMCAzNCAtMSAzNSAtNDAgMzUgLTM5IDAgLTQwIDEgLTQwIDM1CjAgMzMgLTIgMzUgLTM1IDM1IGwtMzUgMCAwIC03MHoiLz4KPHBhdGggZD0iTTU2NTAgMTE1IGMwIC0zMyAtMiAtMzUgLTM1IC0zNSAtMzMgMCAtMzUgLTIgLTM1IC0zNSBsMCAtMzUgNzAgMAo3MCAwIDAgNzAgMCA3MCAtMzUgMCBjLTMzIDAgLTM1IC0yIC0zNSAtMzV6Ii8+CjxwYXRoIGQ9Ik0zODAgNDUgbDAgLTM1IDEwNSAwIDEwNSAwIDAgMzUgMCAzNSAtMTA1IDAgLTEwNSAwIDAgLTM1eiIvPgo8cGF0aCBkPSJNODEwIDQ1IGwwIC0zNSAxMTAgMCAxMTAgMCAwIDM1IDAgMzUgLTExMCAwIC0xMTAgMCAwIC0zNXoiLz4KPHBhdGggZD0iTTEyNDAgNDUgbDAgLTM1IDExMCAwIDExMCAwIDAgMzUgMCAzNSAtMTEwIDAgLTExMCAwIDAgLTM1eiIvPgo8cGF0aCBkPSJNMTY4MCA0NSBsMCAtMzUgMTA1IDAgMTA1IDAgMCAzNSAwIDM1IC0xMDUgMCAtMTA1IDAgMCAtMzV6Ii8+CjxwYXRoIGQ9Ik0yMTEwIDQ1IGwwIC0zNSAxMDUgMCAxMDUgMCAwIDM1IDAgMzUgLTEwNSAwIC0xMDUgMCAwIC0zNXoiLz4KPHBhdGggZD0iTTI1NDAgNDUgbDAgLTM1IDExMCAwIDExMCAwIDAgMzUgMCAzNSAtMTEwIDAgLTExMCAwIDAgLTM1eiIvPgo8cGF0aCBkPSJNMjk4MCA0NSBsMCAtMzUgMTA1IDAgMTA1IDAgMCAzNSAwIDM1IC0xMDUgMCAtMTA1IDAgMCAtMzV6Ii8+CjxwYXRoIGQ9Ik0zNDEwIDQ1IGwwIC0zNSAxMDUgMCAxMDUgMCAwIDM1IDAgMzUgLTEwNSAwIC0xMDUgMCAwIC0zNXoiLz4KPHBhdGggZD0iTTM4NDAgNDUgbDAgLTM1IDEwNSAwIDEwNSAwIDAgMzUgMCAzNSAtMTA1IDAgLTEwNSAwIDAgLTM1eiIvPgo8cGF0aCBkPSJNNDI4MCA0NSBsMCAtMzUgMTA1IDAgMTA1IDAgMCAzNSAwIDM1IC0xMDUgMCAtMTA1IDAgMCAtMzV6Ii8+CjxwYXRoIGQ9Ik00NzEwIDQ1IGwwIC0zNSAxMDUgMCAxMDUgMCAwIDM1IDAgMzUgLTEwNSAwIC0xMDUgMCAwIC0zNXoiLz4KPHBhdGggZD0iTTUxNDAgNDUgbDAgLTM1IDEwNSAwIDEwNSAwIDAgMzUgMCAzNSAtMTA1IDAgLTEwNSAwIDAgLTM1eiIvPgo8L2c+Cjwvc3ZnPgo="
LABEL oc.keyword="microSAM"
LABEL oc.cat="development"
LABEL oc.template="abcdesktopio/oc.template.gtk"
LABEL oc.name="microsam"
LABEL oc.launch="microsam.napari"
LABEL oc.displayname="microSAM"
LABEL oc.path="/opt/conda/envs/microsam/bin/napari"
LABEL oc.type=app
LABEL oc.rules="{\"homedir\":{\"default\":true}}"
LABEL oc.acl="{\"permit\":[\"all\"]}"
LABEL oc.showinview=dock

RUN  if [ -d /usr/share/icons ];   then cd /usr/share/icons;    /composer/safelinks.sh; fi && \
     if [ -d /usr/share/pixmaps ]; then cd /usr/share/pixmaps;  /composer/safelinks.sh; fi 

ENV APPNAME "microsam"
ENV APPBIN "/opt/conda/envs/microsam/bin/napari"
ENV APP "/opt/conda/envs/microsam/bin/napari"


RUN conda create --name microsam python==3.12 micro_sam -c conda-forge && \
    /opt/conda/envs/microsam/bin/pip install torch==2.6.0 torchvision==0.21.0 torchaudio==2.6.0 --index-url https://download.pytorch.org/whl/cu124 

RUN mkdir -p /run/user && chmod 777 /run/user && \
    mkdir -p /etc/localaccount && \
    for f in passwd shadow group gshadow ; do if [ -f /etc/$f ] ; then  cp /etc/$f /etc/localaccount; rm -f /etc/$f; ln -s /etc/localaccount/$f /etc/$f; fi; done


CMD ["/composer/appli-docker-entrypoint.sh" ]


